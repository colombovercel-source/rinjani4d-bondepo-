<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#0b1a2a; color:#fff; font-family:Arial; padding:30px }
h1 { color:#ffcc00 }
input,button { padding:8px; margin:5px }
table { width:100%; border-collapse:collapse; margin-top:20px }
th,td { border:1px solid #1e3a5a; padding:8px; text-align:center }
th { background:#122f4a }
button.approve { background:green; color:white }
button.reject { background:red; color:white }
</style>
</head>

<body>

<div id="loginBox">
  <h1>üîê Admin Login</h1>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
  <p id="msg"></p>
</div>

<div id="panel" style="display:none">
  <h1>üìã Klaim Bonus</h1>
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Deposit</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="data"></tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ‚úÖ SUPABASE 1x SAJA
  const supabase = window.supabase.createClient(
    "https://lzjmyilduranngskrcyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6am15aWxkdXJhbm5nc2tyY3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzU1NjUsImV4cCI6MjA4NjgxMTU2NX0.ybyZTOLYGMOjM_SucsfpsVU3WaL8qVY4m-1XYdK2J7Q"
  );

  document.getElementById("loginBtn").addEventListener("click", login);

  async function login() {
    const email = emailInput.value;
    const password = passwordInput.value;

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return msg.innerText = error.message;

    loginBox.style.display = "none";
    panel.style.display = "block";
    loadData();
    listenRealtime();
  }

  async function loadData() {
    const { data } = await supabase
      .from("bonus_claims")
      .select("*")
      .order("id", { ascending:false });

    renderTable(data);
  }

  function renderTable(data) {
    dataEl.innerHTML = "";

    data.forEach(r => {
      let aksi = "-";

      if (r.status === "Pending") {
        aksi = `
          <button class="approve" data-id="${r.id}">Approve</button>
          <button class="reject" data-id="${r.id}">Reject</button>
        `;
      }

      dataEl.innerHTML += `
        <tr>
          <td>${r.user_id}</td>
          <td>${r.deposit_amount}</td>
          <td>${r.status}</td>
          <td>${aksi}</td>
        </tr>
      `;
    });

    document.querySelectorAll(".approve").forEach(b =>
      b.addEventListener("click", () => updateStatus(b.dataset.id,"Approved"))
    );

    document.querySelectorAll(".reject").forEach(b =>
      b.addEventListener("click", () => updateStatus(b.dataset.id,"Rejected"))
    );
  }

  async function updateStatus(id,status) {
    await supabase.from("bonus_claims")
      .update({ status })
      .eq("id", id);
  }

  // üî• REALTIME TANPA REFRESH
  function listenRealtime() {
    supabase.channel("bonus-realtime")
      .on("postgres_changes",
        { event:"*", schema:"public", table:"bonus_claims" },
        payload => loadData()
      )
      .subscribe();
  }

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const msg = document.getElementById("msg");
  const loginBox = document.getElementById("loginBox");
  const panel = document.getElementById("panel");
  const dataEl = document.getElementById("data");

});
</script>

</body>
</html>
