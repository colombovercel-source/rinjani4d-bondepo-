<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel - Klaim Bonus</title>
<link rel="icon" href="data:,">

<!-- SUPABASE CDN (SATU KALI SAJA) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background:#0b1a2a;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:30px;
}
h1 { color:#ffcc00 }
select { padding:6px; margin-bottom:10px }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  border:1px solid #1e3a5a;
  padding:8px;
  text-align:center;
}
th {
  background:#122f4a;
  color:#ffcc00;
}
button {
  padding:6px 10px;
  cursor:pointer;
  border:none;
  border-radius:4px;
}
.approve { background:#2ecc71; }
.reject { background:#e74c3c; color:#fff }
.undo { background:#f1c40f; }
</style>
</head>

<body>

<h1>üìã Persetujuan - Klaim Bonus</h1>

<select id="filter">
  <option value="All">Semua</option>
  <option value="Pending" selected>Pending</option>
  <option value="Approved">Approved</option>
  <option value="Rejected">Rejected</option>
</select>

<h3 id="total">Total Approved: Rp 0</h3>

<table>
<thead>
<tr>
  <th>User ID</th>
  <th>Deposit</th>
  <th>Status</th>
  <th>Admin</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="data">
<tr><td colspan="5">Loading...</td></tr>
</tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  // ===============================
  // SUPABASE CLIENT (SATU KALI)
  // ===============================
  const supabase = window.supabase.createClient(
    "https://lzjmyilduranngskrcyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6am15aWxkdXJhbm5nc2tyY3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzU1NjUsImV4cCI6MjA4NjgxMTU2NX0.ybyZTOLYGMOjM_SucsfpsVU3WaL8qVY4m-1XYdK2J7Q"
  );

  // ===============================
  // CEK LOGIN ADMIN
  // ===============================
  const { data: auth } = await supabase.auth.getUser();
  if (!auth.user) {
    alert("‚ùå Belum login admin");
    return;
  }
  const adminEmail = auth.user.email;

  const tbody = document.getElementById("data");
  const filter = document.getElementById("filter");
  filter.addEventListener("change", loadData);

  // ===============================
  // LOAD DATA (PAKAI ID, BUKAN created_at)
  // ===============================
  async function loadData() {
    const { data, error } = await supabase
      .from("bonus_claims")
      .select("*")
      .order("id", { ascending: false });

    if (error) {
      console.error(error);
      tbody.innerHTML = "<tr><td colspan='5'>Gagal load data</td></tr>";
      return;
    }

    render(data);
  }

  // ===============================
  // RENDER TABLE
  // ===============================
  function render(rows) {
    tbody.innerHTML = "";
    let total = 0;

    rows.forEach(r => {
      if (filter.value !== "All" && r.status !== filter.value) return;
      if (r.status === "Approved") total += r.deposit_amount;

      let aksi = "-";
      if (r.status === "Pending") {
        aksi = `
          <button class="approve" data-id="${r.id}">Approve</button>
          <button class="reject" data-id="${r.id}">Reject</button>
        `;
      } else {
        aksi = `<button class="undo" data-id="${r.id}">Undo</button>`;
      }

      tbody.innerHTML += `
        <tr>
          <td>${r.user_id}</td>
          <td>${r.deposit_amount.toLocaleString()}</td>
          <td>${r.status}</td>
          <td>${r.approved_by || "-"}</td>
          <td>${aksi}</td>
        </tr>
      `;
    });

    document.getElementById("total").innerText =
      "Total Approved: Rp " + total.toLocaleString();
  }

  // ===============================
  // AKSI BUTTON
  // ===============================
  tbody.addEventListener("click", async e => {
    const id = e.target.dataset.id;
    if (!id) return;

    let status = null;
    if (e.target.classList.contains("approve")) status = "Approved";
    if (e.target.classList.contains("reject")) status = "Rejected";
    if (e.target.classList.contains("undo")) status = "Pending";

    if (!status) return;

    await supabase
      .from("bonus_claims")
      .update({
        status,
        approved_by: status === "Pending" ? null : adminEmail,
        approved_at: status === "Pending" ? null : new Date()
      })
      .eq("id", id);

    loadData();
  });

  // ===============================
  // REALTIME
  // ===============================
  supabase
    .channel("bonus-live")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "bonus_claims" },
      loadData
    )
    .subscribe();

  loadData();
});
</script>

</body>
</html>
