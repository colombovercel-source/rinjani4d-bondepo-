<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel - Klaim Bonus</title>
<link rel="icon" href="data:,">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background:#0b1a2a;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:30px;
}
h1 { color:#ffcc00 }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th, td {
  border:1px solid #1e3a5a;
  padding:8px;
  text-align:center;
}
th {
  background:#122f4a;
  color:#ffcc00;
}
button {
  padding:5px 10px;
  cursor:pointer;
  border:none;
  border-radius:4px;
}
.approve { background:#2ecc71; }
.reject { background:#e74c3c; color:#fff; }
.undo { background:#f1c40f; }
</style>
</head>

<body>

<h1>ðŸ“‹ Persetujuan â€“ Klaim Bonus</h1>

<table>
<thead>
<tr>
  <th>User</th>
  <th>Deposit</th>
  <th>Status</th>
  <th>Admin</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="data">
<tr><td colspan="5">Loading...</td></tr>
</tbody>
</table>

<script>
const supabase = window.supabase.createClient(
  "https://lzjmyilduranngskrcyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6am15aWxkdXJhbm5nc2tyY3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzU1NjUsImV4cCI6MjA4NjgxMTU2NX0.ybyZTOLYGMOjM_SucsfpsVU3WaL8qVY4m-1XYdK2J7Q"
);

async function checkLogin() {
  const { data } = await supabase.auth.getUser();
  if (!data.user) {
    alert("Admin belum login");
    location.href = "/login.html";
  }
  return data.user.email;
}

async function loadData() {
  const { data, error } = await supabase
    .from("bonus_claims")
    .select("*")
    .order("created_at", { ascending: false });

  const tbody = document.getElementById("data");
  tbody.innerHTML = "";

  if (error) {
    console.error(error);
    tbody.innerHTML = "<tr><td colspan='5'>Gagal load data</td></tr>";
    return;
  }

  data.forEach(r => {
    let aksi = "-";
    if (r.status === "Pending") {
      aksi = `
        <button class="approve" data-id="${r.id}">Approve</button>
        <button class="reject" data-id="${r.id}">Reject</button>
      `;
    } else {
      aksi = `<button class="undo" data-id="${r.id}">Undo</button>`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${r.user_id}</td>
        <td>${Number(r.deposit_amount).toLocaleString()}</td>
        <td>${r.status}</td>
        <td>${r.approved_by || "-"}</td>
        <td>${aksi}</td>
      </tr>
    `;
  });
}

async function updateStatus(id, status, admin) {
  await supabase
    .from("bonus_claims")
    .update({
      status,
      approved_by: status === "Pending" ? null : admin,
      approved_at: status === "Pending" ? null : new Date()
    })
    .eq("id", id);
}

document.getElementById("data").addEventListener("click", async e => {
  const id = e.target.dataset.id;
  if (!id) return;

  const admin = await checkLogin();

  if (e.target.classList.contains("approve"))
    updateStatus(id, "Approved", admin);

  if (e.target.classList.contains("reject"))
    updateStatus(id, "Rejected", admin);

  if (e.target.classList.contains("undo"))
    updateStatus(id, "Pending", admin);
});

supabase
  .channel("bonus-live")
  .on("postgres_changes",
    { event:"*", schema:"public", table:"bonus_claims" },
    loadData
  )
  .subscribe();

checkLogin().then(loadData);
</script>

</body>
</html>
