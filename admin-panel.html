<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#0b1a2a; color:#fff; font-family:Arial; padding:30px }
h1 { color:#ffcc00 }
select,button,input { padding:6px; margin:5px }
table { width:100%; border-collapse:collapse; margin-top:15px }
th,td { border:1px solid #1e3a5a; padding:8px; text-align:center }
th { background:#122f4a }
.approve { background:green; color:#fff }
.reject { background:red; color:#fff }
.undo { background:orange }
</style>
</head>

<body>

<h1>ðŸ“‹ Admin Klaim Bonus</h1>

<select id="filter">
  <option value="All">Semua</option>
  <option value="Pending" selected>Pending</option>
  <option value="Approved">Approved</option>
  <option value="Rejected">Rejected</option>
</select>

<h3 id="totalApproved">Total Approved: Rp 0</h3>

<table>
<thead>
<tr>
  <th>User</th>
  <th>Deposit</th>
  <th>Status</th>
  <th>Admin</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="data"></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const supabase = window.supabase.createClient(
    "https://lzjmyilduranngskrcyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6am15aWxkdXJhbm5nc2tyY3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzU1NjUsImV4cCI6MjA4NjgxMTU2NX0.ybyZTOLYGMOjM_SucsfpsVU3WaL8qVY4m-1XYdK2J7Q"
  );

  const filterEl = document.getElementById("filter");
  filterEl.addEventListener("change", loadData);

  async function loadData() {
    const { data } = await supabase
      .from("bonus_claims")
      .select("*")
      .order("id",{ascending:false});

    render(data);
  }

  function render(rows) {
    const tbody = document.getElementById("data");
    tbody.innerHTML = "";

    let total = 0;
    const filter = filterEl.value;

    rows.forEach(r => {
      if (filter !== "All" && r.status !== filter) return;

      if (r.status === "Approved") total += r.deposit_amount;

      let aksi = "-";
      if (r.status === "Pending") {
        aksi = `
          <button class="approve" data-id="${r.id}">Approve</button>
          <button class="reject" data-id="${r.id}">Reject</button>`;
      } else {
        aksi = `<button class="undo" data-id="${r.id}">Undo</button>`;
      }

      tbody.innerHTML += `
        <tr>
          <td>${r.user_id}</td>
          <td>${r.deposit_amount}</td>
          <td>${r.status}</td>
          <td>${r.approved_by || "-"}</td>
          <td>${aksi}</td>
        </tr>`;
    });

    document.getElementById("totalApproved").innerText =
      "Total Approved: Rp " + total.toLocaleString();

    bindActions();
  }

  async function bindActions() {
    const user = (await supabase.auth.getUser()).data.user;

    document.querySelectorAll(".approve").forEach(b =>
      b.onclick = () => update(b.dataset.id,"Approved",user.email));

    document.querySelectorAll(".reject").forEach(b =>
      b.onclick = () => update(b.dataset.id,"Rejected",user.email));

    document.querySelectorAll(".undo").forEach(b =>
      b.onclick = () => update(b.dataset.id,"Pending",null));
  }

  async function update(id,status,admin) {
    await supabase.from("bonus_claims").update({
      status,
      approved_by: admin,
      approved_at: admin ? new Date() : null
    }).eq("id",id);
  }

  // REALTIME
  supabase.channel("realtime-admin")
    .on("postgres_changes",
      {event:"*",schema:"public",table:"bonus_claims"},
      () => loadData()
    ).subscribe();

  loadData();
});
</script>

</body>
</html>
